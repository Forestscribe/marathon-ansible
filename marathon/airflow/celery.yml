- name: "Deploy AirFlow Workflow Management (Celery)"
  marathon:
    marathon_uri: "{{ marathon_uri }}"
    group_id: airflow/celery/
    group_json:
      dependencies:
        - /core/lb
        - /core/logging
        - /airflow/backends
      apps:
        - id: "webserver"
          dependencies:
            - /airflow/backends/redis
            - /airflow/backends/pg
          cpus: 1
          mem: 512
          disk: 0
          instances: 1
          args: [ "webserver" ]
          container:
            type: DOCKER
            volumes:
              - hostPath: airflowdags
                containerPath: /usr/local/airflow/dags
                mode: RW
              - containerPath: "airflowdags"
                mode: "RW"
                persistent:
                  type: "root"
                  size: 1024
            docker:
              image: "stibbons31/docker-airflow-dev"
              # image: "puckel/docker-airflow"
              network: BRIDGE
              privileged: false
              parameters: "{{ docker_log_driver_parameters }}"
              forcePullImage: true
              portMappings:
                  - containerPort: 8080
                    protocol: tcp
                    servicePort: "{{ servicePorts.airflow_celery_backend }}"
          env:
            EXECUTOR: "Celery"
            POSTGRES_USER: airflow
            POSTGRES_PASSWORD: airflow
            POSTGRES_HOST: "{{ docker_ip }}"
            POSTGRES_PORT: "{{ servicePorts.airflow_pg }}"
            POSTGRES_DB: "airflow"
            REDIS_HOST: "{{ docker_ip }}"
            REDIS_PORT: "{{ servicePorts.airflow_redis }}"
            FRENET_KEY: AFKp0LrregZGOucp22eOr0jW0Ru2PmbZzBWoeCdL8Vk=
            LOAD_EX: "y" # Do load default example DAGs
          healthChecks:
            - path: "/health"
              protocol: "HTTP"
              portIndex: 0
              gracePeriodSeconds: 300
              intervalSeconds: 60
              timeoutSeconds: 20
              maxConsecutiveFailures: 3
              ignoreHttp1xx: false
          residency:
            taskLostBehavior: "WAIT_FOREVER"
          upgradeStrategy:
            minimumHealthCapacity: 0.5
            maximumOverCapacity: 0
          labels:
            subdomain: '/airflow/celery/server'
            HAPROXY_GROUP: external
            HAPROXY_BIND_ADDR: 172.17.0.1
            traefik.enable: "true"
            # traefik.frontend.rule: "Host:airflow.{domain}"
            traefik.frontend.rule: "Host:airflow.t.forestscribe.{{ domain_ext }}"

        - id: "flower"
          dependencies:
            - /airflow/backends/redis
            - /airflow/backends/pg
          cpus: 1
          mem: 512
          disk: 0
          instances: 1
          args: ["flower"]
          container:
            type: DOCKER
            volumes:
              - hostPath: airflowdags
                containerPath: /usr/local/airflow/dags
                mode: RW
              - containerPath: "airflowdags"
                mode: "RW"
                persistent:
                    type: "root"
                    size: 1024
            docker:
              image: "stibbons31/docker-airflow-dev"
              # image: "puckel/docker-airflow"
              network: BRIDGE
              privileged: false
              parameters: "{{ docker_log_driver_parameters }}"
              forcePullImage: true
              portMappings:
                - containerPort: 5555
                  protocol: tcp
                  servicePort: "{{ servicePorts.airflow_celery_flower }}"
          env:
            EXECUTOR: "Celery"
            POSTGRES_USER: airflow
            POSTGRES_PASSWORD: airflow
            POSTGRES_HOST: "{{ docker_ip }}"
            POSTGRES_PORT: "{{ servicePorts.airflow_pg }}"
            POSTGRES_DB: "airflow"
            REDIS_HOST: "{{ docker_ip }}"
            REDIS_PORT: "{{ servicePorts.airflow_redis }}"
            FRENET_KEY: AFKp0LrregZGOucp22eOr0jW0Ru2PmbZzBWoeCdL8Vk=
            LOAD_EX: "y" # Do load default example DAGs
          healthChecks:
            - path: "/"
              protocol: "HTTP"
              portIndex: 0
              gracePeriodSeconds: 300
              intervalSeconds: 60
              timeoutSeconds: 20
              maxConsecutiveFailures: 3
              ignoreHttp1xx: false
          residency:
            taskLostBehavior: "WAIT_FOREVER"
          upgradeStrategy:
            minimumHealthCapacity: 0.5
            maximumOverCapacity: 0
          labels:
            subdomain: '/airflow/celery/flower'
            HAPROXY_GROUP: external
            HAPROXY_BIND_ADDR: 172.17.0.1
            traefik.enable: "true"
            # traefik.frontend.rule: "Host:flower.{domain}"
            traefik.frontend.rule: "Host:flower.t.forestscribe.{{ domain_ext }}"

        - id: "/airflow/celery/scheduler"
          dependencies:
            - /airflow/backends/redis
            - /airflow/backends/pg
          cpus: 1
          mem: 512
          disk: 0
          instances: 1
          args: ["scheduler", "--num_runs=-1", "--run-duration=-1"]
          container:
            type: DOCKER
            volumes:
              - hostPath: airflowdags
                containerPath: /usr/local/airflow/dags
                mode: RW
              - containerPath: "airflowdags"
                mode: "RW"
                persistent:
                  type: "root"
                  size: 1024
            docker:
              image: "stibbons31/docker-airflow-dev"
              # image: "puckel/docker-airflow"
              network: BRIDGE
              privileged: false
              parameters: "{{ docker_log_driver_parameters }}"
              forcePullImage: true
          env:
            EXECUTOR: "Celery"
            POSTGRES_USER: airflow
            POSTGRES_PASSWORD: airflow
            POSTGRES_HOST: "{{ docker_ip }}"
            POSTGRES_PORT: "{{ servicePorts.airflow_pg }}"
            POSTGRES_DB: "airflow"
            REDIS_HOST: "{{ docker_ip }}"
            REDIS_PORT: "{{ servicePorts.airflow_redis }}"
            LOAD_EX: "y" # Do load default example DAGs
            FRENET_KEY: AFKp0LrregZGOucp22eOr0jW0Ru2PmbZzBWoeCdL8Vk=
          residency:
            taskLostBehavior: "WAIT_FOREVER"
          healthChecks:
            - protocol: "COMMAND"
              command:
                value: "echo 0"
              gracePeriodSeconds: 300
              intervalSeconds: 60
              timeoutSeconds: 20
              maxConsecutiveFailures: 3
              ignoreHttp1xx: false

        - id: "worker"
          dependencies:
            - /airflow/backends/redis
            - /airflow/backends/pg
            - scheduler
          cpus: 1
          mem: 512
          disk: 0
          instances: 5
          args: ["worker"]
          container:
            type: DOCKER
            volumes:
              - hostPath: airflowdags
                containerPath: /usr/local/airflow/dags
                mode: RW
              - containerPath: "airflowdags"
                mode: "RW"
                persistent:
                  type: "root"
                  size: 1024
            docker:
              # image: "puckel/docker-airflow"
              image: "stibbons31/docker-airflow-dev"
              network: BRIDGE
              privileged: false
              parameters: "{{ docker_log_driver_parameters }}"
              forcePullImage: true
              portMappings:
                - containerPort: 8793
                  protocol: tcp
                  servicePort: "{{ servicePorts.airflow_celery_worker_log }}"
          env:
            EXECUTOR: "Celery"
            POSTGRES_USER: airflow
            POSTGRES_PASSWORD: airflow
            POSTGRES_HOST: "{{ docker_ip }}"
            POSTGRES_PORT: "{{ servicePorts.airflow_pg }}"
            POSTGRES_DB: "airflow"
            REDIS_HOST: "{{ docker_ip }}"
            REDIS_PORT: "{{ servicePorts.airflow_redis }}"
            FRENET_KEY: AFKp0LrregZGOucp22eOr0jW0Ru2PmbZzBWoeCdL8Vk=
            http_proxy: http://proxy-ir.{{ domain_ext }}:911
            https_proxy: http://proxy-ir.{{ domain_ext }}:911
            no_proxy: 127.0.0.1,localhost,{{ domain_ext }},.{{ domain_ext }},172.17.0.1
            HTTP_PROXY: http://proxy-ir.{{ domain_ext }}:911
            HTTPS_PROXY: http://proxy-ir.{{ domain_ext }}:911
            NO_PROXY: 127.0.0.1,localhost,{{ domain_ext }},.{{ domain_ext }},172.17.0.1
            ALL_PROXY: socks://proxy-ir.{{ domain_ext }}:1080
            LOAD_EX: "y" # Do load default example DAGs
          healthChecks:
            - protocol: "TCP"
              portIndex: 0
              gracePeriodSeconds: 300
              intervalSeconds: 60
              timeoutSeconds: 20
              maxConsecutiveFailures: 3
            # - protocol: "COMMAND"
            #   command:
            #     value: "echo 0"
            #   gracePeriodSeconds: 300
            #   intervalSeconds: 60
            #   timeoutSeconds: 20
            #   maxConsecutiveFailures: 3
            #   ignoreHttp1xx: false
          residency:
            taskLostBehavior: "WAIT_FOREVER"
          upgradeStrategy:
            minimumHealthCapacity: 0.5
            maximumOverCapacity: 0
          labels:
            subdomain: '/airflow/worker'
            HAPROXY_GROUP: external
            HAPROXY_BIND_ADDR: 172.17.0.1
