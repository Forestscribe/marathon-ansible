---
- name: Deploy ngrok
  marathon:
    marathon_uri: "{{ marathon_uri }}"
    app_id: ngrok
    app_json:
        cmd: ngrok http {{ docker_ip }}:{{ servicePorts['buildbot_hooks'] }}
        cpus: 0.5
        mem: 64
        disk: 0
        instances: 1
        container:
          type: DOCKER
          docker:
            image:  "forestscribe/docker-ngrok"
            network: BRIDGE
            privileged: false
            parameters: []
            forcePullImage: false
            portMappings:
              - containerPort: 4040
                protocol: tcp
                servicePort: "{{ servicePorts['ngrok'] }}"
        env:
            http_proxy: "{{proxy_env['http_proxy']}}"
        labels:
          HAPROXY_GROUP: external
          HAPROXY_BIND_ADDR: 172.17.0.1

        healthChecks:
        -
          path: /api/tunnels
          protocol: HTTP
          portIndex: 0
          gracePeriodSeconds: 300
          intervalSeconds: 60
          timeoutSeconds: 20
          maxConsecutiveFailures: 3
          ignoreHttp1xx: false
