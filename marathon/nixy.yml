- name: upload nixy.toml conf in zk
  znode:
    hosts: "{{ zk_host }}"
    name: "/etc/nixy/nixy.toml"
    value: "{{ lookup('template', 'nixy/nixy.toml') }}"
    state: present

- name: upload nginx.tmpl conf in zk
  znode:
    hosts: "{{ zk_host }}"
    name: "/etc/nixy/nginx.tmpl"
    value: "{{ lookup('file', 'nixy/nginx.tmpl') }}"
    state: present

- name: Deploy nixy on marathon
  marathon:
    marathon_uri: "{{ marathon_uri }}"
    app_id: nixy
    app_json:
        id: nixy
        cpus: 1
        mem: 1024
        disk: 0
        instances: "{{ marathon_num_agents }}"
        container:
          type: DOCKER
          docker:
            image: "forestscribe/docker-nixy"
            network: BRIDGE
            privileged: false
            parameters: []
            forcePullImage: true
            portMappings:
            - containerPort: 7000
              hostPort: 80
              protocol: tcp
        env:
            MARATHON_LIST: "\"[\"{{ marathon_uri }}\"]\""

        uris:
            - "{{ zk_http_url }}/etc/nixy/nixy.toml"
            - "{{ zk_http_url }}/etc/nixy/nginx.tmpl"

        healthChecks:
        - "{{ basic_http_health_check }}"
        upgradeStrategy:
            minimumHealthCapacity: 0.5
